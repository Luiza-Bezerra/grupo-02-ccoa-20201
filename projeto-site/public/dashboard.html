<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css"
		integrity="sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay" crossorigin="anonymous">

	<link rel="stylesheet" href="css/dash.css">
		<link rel="shortcut icon" href="img/desk-lamp.png">
	<title>Dashboard - Luminous</title>
</head>

<body>

	<div class="header">
		<div class="container">
			<div>
				<img class="icon-ball" src="img/desk-lamp.png" alt="">
			</div>
			<div class="title-header">
				<b><span class="highlight" style="font-size: 30px;"><span
							style="color:  #ffd700;">Lumi</span>nous</span></b>
			</div>
			<div class="nav">
				<ul>
					<li class="nav-dash"><a href="dashboard.html" style="color:#ffd700">Dashboard</a></li>
					<li class="nav-jogos"><a href="conta.html">Conta</a></li>
					<li class="nav-favoritos"><a href="filial.html">Cadastrar Filiais</a></li>
					<li class="nav-dropdown">
						<button class="dropbtn">
							<img class="icon-user" src="img/user.png" alt="">
							<div class="ola">Olá, <span id="b_usuario"></span></div>
						</button>

						<div class="dropdown-content">

							<a class="sign-out" href="#" onclick="logoff()">Sair</a>
						</div>
					</li>
				</ul>
			</div>
		</div>
	</div>



	</div>
	<div class="div_title">
		<span>Gráfico de Luminosidade</span>
	</div>
	<div class="grafico">
		<div style="width:95%;">
			<div id="div_aguarde">Dados sendo obtidos...</div>
			<canvas id="canvas_grafico"></canvas>
		</div>
	</div>
	</div>
	<div class="div_title">
		<span>Gráfico de Gastos / Mês</span>
	</div>
	<div style="margin-bottom: 80px;" class="grafico">
		<div style=width:107%; id="chart_div">
			<canvas id="LineChart" height="500px"></canvas>
		</div>
	</div>
	<div class="footer">
		<div class="container-footer-left">
			<p>
			<h2>Sobre a Luminous</h2>
			</p>
			<p>A Luminous foi fundada em 2020, visando solucionar os problemas de gastos desnecessário de energia
				elétrica,
				percebemos que varias instituições podem economizar muito dinheiro somente cortando gastos relacionados
				a luz,
				então decidimos agir para que essas instituições possam economizar dinheiro através do controle desse
				gastos.
			</p>
		</div>

		<div class="container-footer-right">
			<div class="icons">
				<ul>
					<a target="_blank" href="https://www.instagram.com/empresa_luminous/">
						<li> <img src="img/instagram.png" class="logo" alt=""> </li>
					</a>
					<a target="_blank" href="https://www.facebook.com/Luminous-115033170192448/?modal=admin_todo_tour">
						<li><img src="img/facebook.png" class="logo" alt=""></li>
					</a>
					<a target="_blank" href="https://github.com/BandTec/Grupo-02-CCO-Luminous-">
						<li><img src="img/github.png" class="logo" alt=""></li>
					</a>
					<a target="_blank" href="">
						<li><img src="img/linkedin.png" class="logo" alt=""></li>
					</a>
				</ul>
			</div>
		</div>
		<div style="position: absolute;margin-left: 54.4%;
	margin-top: 80px;width: 300px;" class="duvida">
			<div class="lado-duvida">
				<b style="font-size: 20px;margin-top: 26px;position: absolute;">Insira Seu Email:</b> <a
					href="manual-de-instalacao.docx" download="Manual"><i title="Baixar Manual de Instalação"
						class="fas fa-question"></i></a> <br></div>

			<form method="POST" action="" id="form_email" onsubmit="return enviarDuvida()" class="lado-duvida">
				<input placeholder="receba novidas sobre a Luminous" id="input-email-footer" type="text" name="email">
				<br>
				<input id="btn-email-footer" type="submit" style="cursor: pointer;" value="OK" class="btnNov">
			</form>
		</div>
	</div>
	<div class="footer_copyright">
		© copyright <b>Luminous</b>. All Rights Reserved. <br>
		Design by <b>Equipe de Ti da Luminous.</b>
	</div>

	<script type="text/javascript" src="https://www.chartjs.org/dist/2.8.0/Chart.min.js"></script>
	<script type="text/javascript" src="https://www.chartjs.org/samples/latest/utils.js"></script>
	<script type="text/javascript" src="funcoes.js"></script>
	<script src="funcoes.js"></script>
	<script src="duvida.js"></script>

</body>

</html>

<script>

	var dados = {
		labels: [],
		datasets: [
			{
				yAxisID: 'y-luminosidade',
				label: 'Luminosidade',
				borderColor: window.chartColors.yellow,
				backgroundColor: window.chartColors.yellow,
				fill: false,
				data: []
			}
		]
	};

	window.onload = obterDadosGrafico;

	verificar_autenticacao();

	// neste JSON tem que ser 'labels', 'datasets' etc, 
	// porque é o padrão do Chart.js



	// só mexer se quiser alterar o tempo de atualização
	// ou se souber o que está fazendo!
	function atualizarGrafico() {

		fetch('/leituras/tempo-real', { cache: 'no-store' }).then(function (response) {
			if (response.ok) {
				response.json().then(function (novoRegistro) {

					console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);

					// tirando e colocando valores no gráfico
					dados.labels.shift(); // apagar o primeiro
					dados.labels.push(novoRegistro.momento_grafico); // incluir um novo momento
					dados.datasets[0].data.shift();  // apagar o primeiro de temperatura
					dados.datasets[0].data.push(novoRegistro.GrauLum); // incluir uma nova leitura de temperatura
					window.grafico_linha.update();

					setTimeout(atualizarGrafico, 5000);
				});
			} else {
				console.error('Nenhum dado encontrado ou erro na API');
				setTimeout(atualizarGrafico, 5000);
			}
		})
			.catch(function (error) {
				console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
			});

	}

	// altere aqui as configurações do gráfico
	// (tamanhos, cores, textos, etc)
	function configurarGrafico() {
		var configuracoes = {
			responsive: true,
			animation: { duration: 500 },
			hoverMode: 'index',
			stacked: false,
			title: {
				display: true,
				text: 'Histórico recente de luminosidade'
			},
			scales: {
				yAxes: [{
					type: 'linear', // only linear but allow scale type registration. This allows extensions to exist solely for log scale for instance
					display: true,
					position: 'left',
					id: 'y-luminosidade',
				}],
			}
		};

		return configuracoes;
	}

	// altere aqui como os dados serão exibidos
	// e como são recuperados do BackEnd
	function obterDadosGrafico() {

		fetch('/leituras/ultimas', { cache: 'no-store' }).then(function (response) {
			if (response.ok) {
				response.json().then(function (resposta) {

					console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);

					resposta.reverse();

					for (i = 0; i < resposta.length; i++) {
						var registro = resposta[i];

						// aqui, após 'registro.' use os nomes 
						// dos atributos que vem no JSON 
						// que gerou na consulta ao banco de dados

						dados.labels.push(registro.momento_grafico);

						dados.datasets[0].data.push(registro.GrauLum);
					}
					console.log(JSON.stringify(dados));

					div_aguarde.style.display = 'none';

					plotarGrafico(dados);
				});
			} else {
				console.error('Nenhum dado encontrado ou erro na API');
			}
		})
			.catch(function (error) {
				console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
			});

	}

	// só altere aqui se souber o que está fazendo!
	function plotarGrafico(dados) {
		console.log('iniciando plotagem do gráfico...');

		var ctx = canvas_grafico.getContext('2d');
		window.grafico_linha = Chart.Line(ctx, {
			data: dados,
			options: configurarGrafico()
		});
		setTimeout(atualizarGrafico, 5000);
	}

</script>
<script>
	var script = document.createElement("script");
	script.type = "text/javascript";
	script.src = "https://luminous.ngdesk.com/widgets/chat/5eea3c9b48c71a0007baf739/chat_widget.js";

	document.getElementsByTagName("head")[0].appendChild(script);
</script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script>
	google.charts.load('current', { packages: ['corechart', 'line'] });
	google.charts.setOnLoadCallback(drawAxisTickColors);

	function drawAxisTickColors() {
		var data = new google.visualization.DataTable();
		data.addColumn('number', 'X');
		data.addColumn('number', 'Sem Luminous');
		data.addColumn('number', 'Com Luminous');

		data.addRows([
			[1, 278, 227], [2, 364, 283], [3, 369, 303], [4, 297, 253], [5, 309, 277], [6, 286, 257],
			[7, 325, 281], [8, 337, 269], [9, 270, 243], [10, 299, 240], [11, 312, 271], [12, 283, 251],
		]);

		var options = {
			hAxis: {
				title: 'Mês',
				textStyle: {
					color: 'black',
					fontSize: 20,
					fontName: 'Arial',
					bold: true,
				},

				titleTextStyle: {
					color: 'black',
					fontSize: 18,
					fontName: 'Arial',
					bold: false,
					italic: false
				}
			},
			vAxis: {
				title: 'Valor em R$',
				textStyle: {
					color: 'black',
					fontSize: 20,
					fontName: 'Arial',
					bold: true,
				},

				titleTextStyle: {
					color: 'black',
					fontName: 'Arial',
					fontSize: 20,
					bold: false
				},
			},
			colors: ['red', 'green'],
			legend: { position: "top" }
		};
		var chart = new google.visualization.LineChart(document.getElementById('chart_div'));
		chart.draw(data, options);
	}
</script>