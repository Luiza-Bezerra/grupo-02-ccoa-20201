<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script type="text/javascript" src="https://www.chartjs.org/dist/2.8.0/Chart.min.js"></script>
    <script type="text/javascript" src="https://www.chartjs.org/samples/latest/utils.js"></script>
    <script type="text/javascript" src="funcoes.js"></script>
	<link rel="stylesheet" href="css/dash.css">
	<script src="funcoes.js"></script>
	<link rel="shortcut icon" href="img/desk-lamp.png">
    <title>Dashboard</title>
</head>
<body>
    
    <div class="header">
        <div class="container">
            <div>
                <img class="icon-ball" src="img/desk-lamp.png" alt="">
            </div>
            <div class="title-header">
               <b><span class="highlight" style="font-size: 30px;"><span style="color:  #ffd700;">Lumi</span>nous</span></b>
            </div>
            <div class="nav">
                <ul>
                    <li class="nav-dash"><a href="dashboard.html" style="color:#ffd700">Dashboard</a></li>
                    <li class="nav-jogos"><a href="conta.html">Conta</a></li>
                    <li class="nav-favoritos"><a href="filial.html">Cadastrar Filiais</a></li>
                    <li class="nav-dropdown">
                        <button class="dropbtn">
							<img class="icon-user" src="img/user.png" alt=""><span class="ola">Olá, <span id="b_usuario"></span></span>
                        </button>
                        <div class="dropdown-content">
                            
                            <a class="doubt" href="duvidas.html">Duvidas</a>
                            <a class="sign-out" href="#" onclick="logoff()">Sair</a>
                          </div>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <div class="input">
        <h2 style="float: left;">Filtrar Gráficos:</h2>
        <select  id="" class="input-conteudo">
            <option value="">Dia</option>
            <option value="">Mês</option>
            <option value="">Ano</option>

        </select>
        <input type="text" placeholder="Data Especifica(23/09/2020)"  class="input-conteudo">
    </div>
 
    <div class="title"><h1>Gráfico de Luminosidade</h1></div>
    <div class="grafico">
		<div style="width:75%;">
			<div id="div_aguarde">Dados sendo obtidos...</div>
			<canvas id="canvas_grafico"></canvas>
		</div>
    </div>
    <div class="footer">
		<div class="container-footer-left">
		  <p>
			<h2>Sobre a Luminous</h2>
		  </p>
		  <p>A Luminous foi fundada em 2020, visando solucionar os problemas de gastos desnecessário de energia elétrica,
			percebemos que varias instituições podem economizar muito dinheiro somente cortando gastos relacionados a luz,
			então decidimos agir para que essas instituições possam economizar dinheiro através do controle desse gastos.
		  </p>
		</div>
		<div class="container-footer-right">
		  <div class="icons">
			<ul>
			  <a target="_blank" href="https://www.instagram.com/empresa_luminous/"><li> <img src="img/instagram.png" class="logo" alt=""> </li></a>
			  <a target="_blank" href="https://www.facebook.com/Luminous-115033170192448/?modal=admin_todo_tour"><li><img src="img/facebook.png" class="logo" alt=""></li></a>
			  <a target="_blank" href="https://github.com/BandTec/Grupo-02-CCO-Luminous-"><li><img src="img/github.png" class="logo" alt=""></li></a>
			  <a target="_blank" href=""><li><img src="img/linkedin.png" class="logo" alt=""></li></a>
			</ul>
		  </div>
		</div>
	  </div>
	  <div class="footer_copyright">
		© copyright <b>Luminous</b>. All Rights Reserved. <br>
		Design by <b>Equipe de Ti da Luminous.</b>
	  </div>
</body>
</html>
<script>
	 window.onload = obterDadosGrafico;

verificar_autenticacao();

// neste JSON tem que ser 'labels', 'datasets' etc, 
// porque é o padrão do Chart.js
var dados = {
	labels: [],
	datasets: [
		{
			yAxisID: 'y-luminosidade',
			label: 'Luminosidade',
			borderColor: window.chartColors.red,
			backgroundColor: window.chartColors.red,
			fill: false,
			data: []
		}
	]
};


// só mexer se quiser alterar o tempo de atualização
// ou se souber o que está fazendo!
function atualizarGrafico() {

	fetch('/leituras/tempo-real', { cache: 'no-store' }).then(function (response) {
		if (response.ok) {
			response.json().then(function (novoRegistro) {

				console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
				
				// tirando e colocando valores no gráfico
				dados.labels.shift(); // apagar o primeiro
				dados.labels.push(novoRegistro.momento_grafico); // incluir um novo momento
				dados.datasets[0].data.shift();  // apagar o primeiro de temperatura
				dados.datasets[0].data.push(novoRegistro.GrauLum); // incluir uma nova leitura de temperatura
				window.grafico_linha.update();
				
				setTimeout(atualizarGrafico, 5000);
			});
		} else {
			console.error('Nenhum dado encontrado ou erro na API');
			setTimeout(atualizarGrafico, 5000);
		}
	})
	.catch(function (error) {
		console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
	});
	
}

// altere aqui as configurações do gráfico
// (tamanhos, cores, textos, etc)
function configurarGrafico() {
	var configuracoes = {
		responsive: true,
		animation: {duration: 500},
		hoverMode: 'index',
		stacked: false,
		title: {
			display: true,
			text: 'Histórico recente de luminosidade'
		},
		scales: {
			yAxes: [{
				type: 'linear', // only linear but allow scale type registration. This allows extensions to exist solely for log scale for instance
				display: true,
				position: 'left',
				id: 'y-luminosidade',
			}],
		}
	};

	return configuracoes;
}

// altere aqui como os dados serão exibidos
// e como são recuperados do BackEnd
function obterDadosGrafico() {

	fetch('/leituras/ultimas', { cache: 'no-store' }).then(function (response) {
		if (response.ok) {
			response.json().then(function (resposta) {

				console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);

				resposta.reverse();

				for (i = 0; i < resposta.length; i++) {
					var registro = resposta[i];
				
					// aqui, após 'registro.' use os nomes 
					// dos atributos que vem no JSON 
					// que gerou na consulta ao banco de dados

					dados.labels.push(registro.momento_grafico);

					dados.datasets[0].data.push(registro.GrauLum);
				}
				console.log(JSON.stringify(dados));

				div_aguarde.style.display = 'none';

				plotarGrafico(dados);
			});
		} else {
			console.error('Nenhum dado encontrado ou erro na API');
		}
	})
	.catch(function (error) {
		console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
	});

}

// só altere aqui se souber o que está fazendo!
function plotarGrafico(dados) {
	console.log('iniciando plotagem do gráfico...');

	var ctx = canvas_grafico.getContext('2d');
	window.grafico_linha = Chart.Line(ctx, {
		data: dados,
		options: configurarGrafico()
	});
	setTimeout(atualizarGrafico, 5000);
}

</script>
<script>
var script = document.createElement("script");
script.type = "text/javascript";
script.src = "https://luminous.ngdesk.com/widgets/chat/5eea3c9b48c71a0007baf739/chat_widget.js";
document.getElementsByTagName("head")[0].appendChild(script);
</script>
